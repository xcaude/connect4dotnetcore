@page "/games"
@using System.Net.Http
@using System.Net.Http.Headers
@using System.Text.Json
@using System.Text
@using System.IdentityModel.Tokens.Jwt
@using Connect4Game.Domain.Model
@using Connect4Game.Common.Dto

@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager NavigationManager

<link rel="stylesheet" href="css/games.css" />

<div class="game-list-container">
    <div class="game-list">
        <h3>
            <span class="game">Game</span>
            <span class="list">List</span>
        </h3>
        @if (games == null)
        {
            <p><em>Loading...</em></p>
        }
        else
        {
            <ul>
                @foreach (var game in games)
                {
                    <li>
                        <div class="game-details">
                            <span>@game.Name</span>
                            <span>Host: @game.Host</span>
                            <span>Guest: @game.Guest</span>
                            <span>currentUser : @currentUser</span>
                        </div>



                        <td>
                            @if (game.Host == currentUser || game.Guest == currentUser)
                            {
                                <button class="play-button" @onclick="() => PlayGame(game.Id)">Play</button>
                            }
                            else if (game.Status == "Awaiting Guest")
                            {
                                <button @onclick="() => JoinGame(game.Id)">Join</button>
                            }
                        </td>
                    </li>
                }
            </ul>
        }
    </div>
    <div class="register-game">
        <h3>Register Game</h3>
        <div>
            <label>Name:</label>
            <input @bind="newGameName" />
        </div>
        <button @onclick="RegisterGame">Register</button>
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <p style="color:red">@errorMessage</p>
        }
    </div>
</div>

@code {
    private List<ListedGameDto> games;
    private string newGameName;
    private string jwtToken;
    private string errorMessage;

    private string currentUser;

    private string GetUserFromJwt(string jwtToken)
    {
        var handler = new JwtSecurityTokenHandler();
        var jsonToken = handler.ReadToken(jwtToken) as JwtSecurityToken;
        var userClaim = jsonToken?.Claims.FirstOrDefault(claim => claim.Type == System.Security.Claims.ClaimTypes.Name);
        return userClaim?.Value;
    }

    protected override async Task OnInitializedAsync()
    {
        jwtToken = await JS.InvokeAsync<string>("localStorage.getItem", "jwtToken");
        currentUser = GetUserFromJwt(jwtToken);
        await LoadGames();
    }

    private async Task LoadGames()
    {
        var request = new HttpRequestMessage(HttpMethod.Get, "http://localhost:5034/api/games");
        request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", jwtToken);

        var response = await Http.SendAsync(request);
        if (response.IsSuccessStatusCode)
        {
            var responseContent = await response.Content.ReadAsStringAsync();
            games = JsonSerializer.Deserialize<List<ListedGameDto>>(responseContent, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
        }
        else
        {
            Console.WriteLine($"Error: {response.ReasonPhrase}");
        }
    }

    private async Task RegisterGame()
    {
        errorMessage = string.Empty;

        var gameData = new CreateGameDto { Name = newGameName };
        var jsonContent = new StringContent(JsonSerializer.Serialize(gameData), Encoding.UTF8, "application/json");

        var request = new HttpRequestMessage(HttpMethod.Post, "http://localhost:5034/api/games")
        {
            Content = jsonContent
        };
        request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", jwtToken);
        request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

        try
        {
            var response = await Http.SendAsync(request);

            if (response.IsSuccessStatusCode)
            {
                // Reload the games list after successful registration
                await LoadGames();
                newGameName = string.Empty; // Reset the form
            }
            else
            {
                errorMessage = "Failed to register game";
                Console.WriteLine($"Error: {response.ReasonPhrase}");
            }
        }
        catch (Exception ex)
        {
            errorMessage = "An error occurred during game registration.";
            Console.WriteLine($"Exception: {ex.Message}");
        }
    }

    private async Task JoinGame(int gameId)
    {
        errorMessage = string.Empty;

        var request = new HttpRequestMessage(HttpMethod.Post, $"http://localhost:5034/api/games/{gameId}/join");
        request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", jwtToken);

        var response = await Http.SendAsync(request);
        if (response.IsSuccessStatusCode)
        {
            NavigationManager.NavigateTo($"/game/{gameId}");
        }
        else
        {
            errorMessage = "Failed to join game";
            Console.WriteLine($"Error: {response.ReasonPhrase}");
        }
    }

    private void PlayGame(int gameId)
    {
        NavigationManager.NavigateTo($"/game/{gameId}");
    }
}